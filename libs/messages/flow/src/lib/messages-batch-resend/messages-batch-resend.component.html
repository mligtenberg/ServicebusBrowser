<div class="batch-resend-container" [ngClass]="{ darkMode: darkMode() }">
  <div class="batch-resend-header">
    <h2 class="title">Batch Actions</h2>
    <p class="subtitle">Create a list of actions to modify your messages before resending</p>
  </div>

  <div class="destination-selector">
    <h3>Select Destination</h3>
    <sbb-tpl-endpoint-selector-input [(ngModel)]="selectedEndpoint" placeholder="Select destination endpoint" />
  </div>

  <div class="actions-container">
    <div class="actions-list">
      <div class="actions-header">
        <h3>Actions</h3>
        <div class="actions-header-buttons">
          <p-button icon="pi pi-upload" severity="secondary" text="true" tooltip="Import Actions" (click)="importActions()"></p-button>
          <p-button icon="pi pi-download" severity="secondary" text="true" tooltip="Export Actions" [disabled]="actions().length === 0" (click)="exportActions()"></p-button>
        </div>
      </div>
      <p-scroll-panel [style]="{height: 'calc(100% - 7em)'}" *ngIf="actions().length > 0">
        <div class="action-item" *ngFor="let action of actions(); let i = index">
          <div class="action-summary">
            <div class="action-type">{{ getActionTypeLabel(action.type) }}</div>
            <div class="action-target">{{ getActionTargetLabel(action.target) }}</div>
            <div class="action-details">{{ getActionDescription(action) }}</div>
          </div>
          <div class="action-buttons">
            <p-button icon="pi pi-trash" severity="danger" text="true" (click)="removeAction(i)"></p-button>
          </div>
        </div>
      </p-scroll-panel>

      <div class="empty-state" [style]="{height: 'calc(100% - 7em)'}" *ngIf="actions().length === 0">
        <p>No actions added yet. Add actions below to modify your messages before resending.</p>
      </div>

      <div class="action-controls">
        <p-button label="Preview Changes" icon="pi pi-eye" [disabled]="actions().length === 0"
                  (click)="previewChanges()"></p-button>
        <p-button label="Resend" icon="pi pi-send" severity="success"
                  [disabled]="actions().length === 0 || !selectedEndpoint" (click)="resendMessages()"></p-button>
      </div>
    </div>

    <div class="action-editor">
      <h3>Add Action</h3>
      <lib-action #actionEditor></lib-action>

      <div class="action-add-button">
        <p-button label="Add Action" icon="pi pi-plus" [disabled]="!canAddAction()" (click)="addAction()"></p-button>
      </div>
    </div>
  </div>
</div>

<p-dialog
  header="Preview Changes"
  [(visible)]="previewDialogVisible"
  [modal]="true"
  [style]="{width: '90vw', height: '90vh'}"
  [draggable]="false"
  [resizable]="false">
  <p-scroll-panel [style]="{width: '100%', height: '60vh'}">
    <div class="preview-container">
      @for (message of previewMessages; track $index) {
        <div class="message-preview">
          <h4>Message ID: {{ message.messageId }}</h4>
          <p-divider></p-divider>
          <p><strong>Body:</strong></p>
          <pre>{{ message.body }}</pre>
          <p-divider></p-divider>
          <p><strong>System Properties:</strong></p>
          <div class="properties-list">
            <div class="property-item" *ngFor="let prop of getSystemProperties(message)">
              <span class="property-name">{{ prop.key }}:</span>
              <span class="property-value">{{ prop.value }}</span>
            </div>
          </div>
          <p-divider></p-divider>
          <p><strong>Application Properties:</strong></p>
          <div class="properties-list">
            <div class="property-item" *ngFor="let prop of getApplicationProperties(message)">
              <span class="property-name">{{ prop.key }}:</span>
              <span class="property-value">{{ prop.value }}</span>
            </div>
          </div>
        </div>
      }
    </div>
  </p-scroll-panel>
  <ng-template pTemplate="footer">
    <p-button label="Close" icon="pi pi-times" (click)="previewDialogVisible = false"
              styleClass="p-button-text"></p-button>
    <p-button label="Resend Messages" icon="pi pi-send" (click)="resendMessages()" severity="success"></p-button>
  </ng-template>
</p-dialog>

<p-toast position="bottom-center"></p-toast>
