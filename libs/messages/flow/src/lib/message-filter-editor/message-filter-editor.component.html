<p-drawer
  header="Filter Messages"
  appendTo="body"
  [(visible)]="visible"
  [modal]="true"
  position="right"
  [style]="{ width: '900px', 'max-width': '90vw' }"
  [closable]="false"
  [dismissible]="false"
>
  <div>
    <div>
      <p-accordion [multiple]="true" [value]="['0', '1', '2']">
        <!-- System Properties -->
        <p-accordion-panel value="0">
          <p-accordion-header>
            <div class="filter-header">
              System Properties
              @let systemFilterTagValue = systemFilterTag();
              @if (systemFilterTagValue) {
                <p-tag>{{ systemFilterTagValue }}</p-tag>
              }
            </div>
          </p-accordion-header>
          <p-accordion-content>
            <div>
              @for (filter of filterForm.systemProperties().value();
                let index = $index;
                track index) {
                <div class="filter-line system-property-filter-line">
                  <p-input-group>
                    <p-inputgroup-addon>
                      <p-checkbox
                        [binary]="true"
                        class="isActive"
                        [formField]="filterForm.systemProperties[index].isActive"
                      />
                    </p-inputgroup-addon>

                    <lib-select-signal-form-input
                      [options]="systemPropertyOptions"
                      [formField]="filterForm.systemProperties[index].fieldName"
                      (valueChange)="onSystemPropertyChange($event, index)"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Select Property"
                      class="fieldName"
                    />

                    @if (filter.fieldType === 'string') {
                      <lib-select-signal-form-input
                        [options]="stringFilterTypes"
                        [formField]="
                        filterForm.systemProperties[index].filterType
                      "
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Filter Type"
                        class="filterType"
                      />
                    }

                    @if (filter.fieldType === 'date') {
                      <lib-select-signal-form-input
                        [options]="dateFilterTypes"
                        [formField]="
                        filterForm.systemProperties[index].filterType
                      "
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Filter Type"
                        class="filterType"
                      />
                    }

                    @if (filter.fieldType === 'number') {
                      <lib-select-signal-form-input
                        [options]="numberFilterTypes"
                        [formField]="
                        filterForm.systemProperties[index].filterType
                      "
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Filter Type"
                        class="filterType"
                      />
                    }

                    @if (filter.fieldType === 'timespan') {
                      <lib-select-signal-form-input
                        [options]="timespanFilterTypes"
                        [formField]="filterForm.systemProperties[index].filterType"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Filter Type"
                        class="filterType"
                      />
                    }

                    @if (filter.fieldType === 'string') {
                      <input
                        pInputText
                        [formField]="
                        asStringValueTree(
                          filterForm.systemProperties[index].value
                        )
                      "
                        placeholder="Value"
                        class="value"
                      />
                    }

                    @if (filter.fieldType === 'date') {
                      <lib-date-picker-signal-form-input
                        [formField]="
                        asDateValueTree(
                          filterForm.systemProperties[index].value
                        )
                      "
                        class="value"
                      />
                    }

                    @if (filter.fieldType === 'number') {
                      <input type="number" pInputText
                             [formField]="
                        asNumberValueTree(
                          filterForm.systemProperties[index].value
                        )
                      "
                             class="value"
                      />
                    }

                    @if (filter.fieldType === 'boolean') {
                      <p-checkbox
                        [formField]="
                        asBooleanValueTree(
                          filterForm.systemProperties[index].value
                        )
                      "
                        [binary]="true"
                        class="value"
                      />
                    }

                    @if (filter.fieldType === 'timespan') {
                      <input
                        (click)="popover.toggle($event)"
                        pInputText
                        readonly
                        [value]="filter.value"
                        class="time-span-trigger"
                        aria-disabled="false"
                        placeholder="Value" />
                      <p-popover
                        appendTo="body"
                        #popover
                      >
                        <sbb-duration-input
                          [formField]="asStringValueTree(filterForm.systemProperties[index].value)"
                        />
                      </p-popover>
                    }

                    <p-button
                      icon="pi pi-trash"
                      severity="danger"
                      (click)="removeSystemPropertyFilter(index)"
                    ></p-button>
                  </p-input-group>
                </div>
              }

              <p-button
                icon="pi pi-plus"
                label="Add System Property Filter"
                variant="outlined"
                (click)="addSystemPropertyFilter()"
              ></p-button>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Application Properties -->
        <p-accordion-panel value="1">
          <p-accordion-header>
            <div class="filter-header">
              Application Properties
              @let applicationFilterTagValue = applicationFilterTag();
              @if (applicationFilterTagValue) {
                <p-tag>{{ applicationFilterTagValue }}</p-tag>
              }
            </div>
          </p-accordion-header>
          <p-accordion-content>
            @for (filter of filterForm.applicationProperties().value();
              let index = $index;
              track index) {
              <div class="filter-line application-property-filter-line">
                <p-input-group>
                  <p-inputgroup-addon>
                    <p-checkbox
                      [formField]="filterForm.applicationProperties[index].isActive"
                      [binary]="true"
                      class="isActive"
                    />
                  </p-inputgroup-addon>

                  <input
                    pInputText
                    [formField]="
                    filterForm.applicationProperties[index].fieldName
                  "
                    placeholder="Property Name"
                    class="fieldName"
                  />

                  <lib-select-signal-form-input
                    [options]="propertyTypes"
                    [formField]="
                    filterForm.applicationProperties[index].fieldType
                  "
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Property Type"
                    class="fieldType"
                  />

                  @if (filter.fieldType === 'string') {
                    <lib-select-signal-form-input
                      [options]="stringFilterTypes"
                      [formField]="
                      filterForm.applicationProperties[index].filterType
                    "
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Filter Type"
                      class="filterType"
                    />
                  }

                  @if (filter.fieldType === 'date') {
                    <lib-select-signal-form-input
                      [options]="dateFilterTypes"
                      [formField]="
                      filterForm.applicationProperties[index].filterType
                    "
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Filter Type"
                      class="filterType"
                    />
                  }

                  @if (filter.fieldType === 'number') {
                    <lib-select-signal-form-input
                      [options]="numberFilterTypes"
                      [formField]="
                      filterForm.applicationProperties[index].filterType
                    "
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Filter Type"
                      class="filterType"
                    />
                  }

                  @if (filter.fieldType === 'string') {
                    <input
                      pInputText
                      [formField]="
                      asStringValueTree(
                        filterForm.applicationProperties[index].value
                      )
                    "
                      placeholder="Value"
                      class="value"
                    />
                  }

                  @if (filter.fieldType === 'date') {
                    <lib-date-picker-signal-form-input
                      [formField]="
                      asDateValueTree(
                        filterForm.applicationProperties[index].value
                      )
                    "
                      class="value"
                    />
                  }

                  @if (filter.fieldType === 'number') {
                    <input type="number" pInputText
                           [formField]="
                      asNumberValueTree(
                        filterForm.applicationProperties[index].value
                      )
                    "
                           class="value"
                    />
                  }

                  @if (filter.fieldType === 'boolean') {
                    <p-checkbox
                      [formField]="
                      asBooleanValueTree(
                        filterForm.applicationProperties[index].value
                      )
                    "
                      [binary]="true"
                      class="value"
                    />
                  }

                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    (click)="removeApplicationPropertyFilter(index)"
                  ></p-button>
                </p-input-group>
              </div>
            }

            <p-button
              icon="pi pi-plus"
              label="Add Application Property Filter"
              variant="outlined"
              (click)="addApplicationPropertyFilter()"
            ></p-button>
          </p-accordion-content>
        </p-accordion-panel>

        <!-- Body -->
        <p-accordion-panel value="2">
          <p-accordion-header>
            <div class="filter-header">
              Message Body
              @let bodyFilterTagValue = bodyFilterTag();
              @if (bodyFilterTagValue) {
                <p-tag>{{ bodyFilterTagValue }}</p-tag>
              }
            </div>
          </p-accordion-header>
          <p-accordion-content>
            @for (filter of filterForm.body().value();
              let index = $index;
              track index) {
                <p-input-group>
                  <p-inputgroup-addon>
                    <p-checkbox
                      [formField]="filterForm.body[index].isActive"
                      [binary]="true"
                      class="isActive"
                    />
                  </p-inputgroup-addon>

                  <lib-select-signal-form-input
                    [options]="bodyFilterTypes"
                    [formField]="filterForm.body[index].filterType"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Filter Type"
                    class="filterType"
                  />

                  <input
                    pInputText
                    [formField]="asStringValueTree(filterForm.body[index].value)"
                    placeholder="Value"
                    class="value"
                  />

                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    (click)="removeBodyFilter(index)"
                  ></p-button>
                </p-input-group>
            }

            <p-button
              icon="pi pi-plus"
              label="Add body Filter"
              variant="outlined"
              (click)="addBodyFilter()"
            ></p-button>
          </p-accordion-content>
        </p-accordion-panel>
      </p-accordion>
    </div>
    <div class="actions">
      <p-button variant="text" (click)="onCancel()"> Cancel</p-button>
      <p-button severity="danger" (click)="onClearAll()"> Clear All</p-button>
      <p-button (click)="onApply()" [disabled]="!isFilterValid()">
        Apply
      </p-button>
    </div>
  </div>
</p-drawer>
