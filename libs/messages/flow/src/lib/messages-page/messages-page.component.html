
<div class="container">
  @if (currentPage(); as page) {
    <lib-messages-viewer
      [pageId]="page.id"
      [messages]="virtualMessages()"
      [lazy]="true"
      (lazyLoadTriggered)="loadMessages($event)"
      [multiselect]="true"
      [messagesContextMenu]="messageContextMenu()"
      [systemPropertiesContextMenu]="systemPropertiesContextMenu()"
      [(systemPropertiesContextMenuSelection)]="systemPropertiesContextMenuSelection"
      [applicationPropertiesContextMenu]="applicationPropertiesContextMenu()"
      [(applicationPropertiesContextMenuSelection)]="applicationPropertiesContextMenuSelection"
      [(selection)]="selection"
      (selectionChange)="onSelectionChange($event)"
      #messagesViewer
    >
      <ng-template #messagesHeader>
        <p-menu #menu [model]="allMessagesMenu()" [popup]="true" appendTo="body" />
        <div class="status-widget" [ngClass]="{ 'dark-mode': !colorThemeService.lightMode() }">
          <div
            type="button"
            class="badge filtered"
            title="Filtered messages"
            aria-label="Filtered messages count"
            pTooltip="Filtered messages count"
            tooltipPosition="bottom"
          >
            <i class="pi pi-search"></i>
            @if (filteredMessageCount() !== undefined) {
              <span class="count">{{ filteredMessageCount() | number }}</span>
              <span class="subtext">({{ filteredPercentage() | number : '1.1-1' }}%)</span>
            }
            @else {
              <i class="pi pi-spin pi-spinner"></i>
            }
          </div>
          <div
            type="button"
            class="badge total"
            title="Total messages count"
            aria-label="Total messages count"
            pTooltip="Total messages count"
            tooltipPosition="bottom"
          >
            <i class="pi pi-inbox"></i>
            @if (totalMessageCount() !== undefined) {
              <span class="count">{{ totalMessageCount() | number }}</span>
            }
            @else {
              <i class="pi pi-spin pi-spinner"></i>
            }
          </div>
        </div>
        <div class="header-buttons">
          <p-button
            (click)="openFilterDialog()"
            [icon]="hasActiveFilters() ? 'pi pi-filter-fill' : 'pi pi-filter'"
            text="true"
          />
          <p-button (click)="menu.show($event)" icon="pi pi-ellipsis-v" text="true" />
        </div>
      </ng-template>
    </lib-messages-viewer>
  }
</div>


  <p-dialog
    header="Send messages"
    appendTo="body"
    [(visible)]="displaySendMessages"
    [modal]="true"
    >
    <p-scroll-panel>
      <sbb-tpl-endpoint-selector-tree-input [(ngModel)]="sendEndpoint" />
    </p-scroll-panel>
    <div class="actions">
      <button
        pButton
        type="button"
        [disabled]="!sendEndpoint()"
        (click)="sendMessages()"
        >
        Send
      </button>
    </div>
  </p-dialog>

  <lib-message-filter-editor
    [(visible)]="displayFilterEditor"
    [filters]="messageFilter()"
    (filtersChange)="onFiltersUpdated($event)"
  ></lib-message-filter-editor>
